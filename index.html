<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watch Together (Bootstrap - Top Video, Bottom Chat)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- PeerJS -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <!-- hls.js for .m3u8 playback on non-Safari browsers -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    body { background: #111; color: #eee; }
    .brand { color:#00e1ff; font-weight:700; }

    /* Top (video) / Bottom (chat) split with draggable horizontal resizer */
    #appWrap { height: calc(100vh - 72px); } /* below navbar */
    #videoPane, #chatPane { position: relative; }

    /* Start 60% video / 40% chat by default */
    #videoPane { height: 60%; }
    #chatPane  { height: 40%; }

    #resizerX {
      height: 8px;
      cursor: row-resize;
      background: linear-gradient(180deg, #333, #444);
      border-radius: 8px;
    }

    /* Player area fills video pane */
    #player-container {
      position: absolute; inset: 0; background:#000; border-radius:10px; overflow:hidden;
      display: grid; place-items: center;
    }
    #player-container iframe, #player-container video { width:100%; height:100%; object-fit: contain; background:#000; }

    /* Guest interaction blocker over the player */
    #guestBlocker { position:absolute; inset:0; display:none; pointer-events:auto; background:transparent; }

    /* Chat */
    #chatBox { position:absolute; inset: 0; display:flex; flex-direction:column; }
    #messages { flex:1 1 auto; overflow-y:auto; background:#111; border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:8px; }
    .msg { max-width:85%; padding:8px 10px; border-radius:12px; line-height:1.3; word-wrap:break-word; }
    .you  { align-self:flex-start; background:#0c1a1f; border:1px solid #00e1ff44; }
    .peer  { align-self:flex-end;   background:#1a0f16; border:1px solid #ff00aa44; }
    .system{ align-self:center;    background:#141414; border:1px dashed #444; font-size:.9rem; color:#bbb; }

    .muted-text { color:#9aa0a6; }
    .role-you  { color:#00e1ff; }
    .role-peer { color:#ff00aa; }

    /* Utilities */
    .hidden { display:none !important; }

    @media (max-width: 768px) {
      #appWrap { height: calc(100vh - 112px); }
      #videoPane { height: 55%; }
      #chatPane  { height: 45%; }
    }
  </style>
</head>
<body>
  <!-- Navbar / Controls -->
  <nav class="navbar navbar-dark bg-dark navbar-expand py-2">
    <div class="container-fluid">
      <span class="navbar-brand brand">ðŸŽ¬ Watch Together</span>

      <div class="ms-auto d-flex align-items-center gap-2" id="preConn">
        <button id="createRoom" class="btn btn-info fw-bold">Create Room</button>
        <input id="roomIdInput" class="form-control form-control-sm" placeholder="Enter Room ID" style="width:220px;"/>
        <button id="joinRoom" class="btn btn-outline-info fw-bold">Join Room</button>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2 hidden" id="inRoom">
        <span class="small"><span id="leftUser" class="role-you fw-bold">You</span> Â· <span id="rightUser" class="role-peer fw-bold">Peer</span></span>
        <button id="toggleChatBtn" class="btn btn-secondary btn-sm" title="Collapse/Expand Chat">Toggle Chat</button>
        <button id="exitBtn" class="btn btn-danger btn-sm">Exit</button>
      </div>
    </div>
  </nav>

  <!-- Host-only video controls -->
  <div id="videoControls" class="container py-2 hidden">
    <div class="row g-2 align-items-center">
      <div class="col-12 col-md-8">
        <input id="videoUrl" class="form-control" placeholder="Paste video URL (.mp4, YouTube, or .m3u8)"/>
      </div>
      <div class="col-6 col-md-2 d-grid">
        <button id="loadVideo" class="btn btn-info fw-bold">Load</button>
      </div>
      <div class="col-6 col-md-2 text-md-end">
        <span class="badge text-bg-dark">Role: <span id="roleBadge" class="text-info">Host</span></span>
      </div>
    </div>
  </div>

  <!-- App split: top video, resizer, bottom chat -->
  <div class="container" id="appWrap">
    <div id="videoPane" class="mb-2">
      <div id="player-container" class="shadow">
        <div id="ytPlayer"></div>
        <video id="html5Player" playsinline></video>
        <div id="guestBlocker" aria-hidden="true"></div>
      </div>
    </div>
    <div id="resizerX" class="my-2 rounded"></div>
    <div id="chatPane">
      <div id="chatBox">
        <div id="messages" class="shadow-sm"></div>
        <div class="input-group mt-2">
          <input id="msgInput" class="form-control" placeholder="Type a message..."/>
          <button id="sendBtn" class="btn btn-info fw-bold">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let peer, conn;
    let isHost = false;
    let ytPlayer;
    const html5Player = document.getElementById('html5Player');
    let currentType = null; // 'yt' | 'html5' | 'hls'
    let hls = null;         // hls.js instance

    // UI refs
    const preConn = document.getElementById('preConn');
    const inRoom = document.getElementById('inRoom');
    const guestBlocker = document.getElementById('guestBlocker');
    const videoControls = document.getElementById('videoControls');
    const roleBadge = document.getElementById('roleBadge');

    const videoPane = document.getElementById('videoPane');
    const chatPane  = document.getElementById('chatPane');
    const resizerX  = document.getElementById('resizerX');

    function show(el, yes) { el.classList.toggle('hidden', !yes); }

    function logBubble(text, who) { // 'you' | 'peer' | 'system'
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'msg ' + (who || 'system');
      div.innerHTML = text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function toggleUI(connected) {
      show(preConn, !connected);
      show(inRoom, connected);
      show(videoControls, connected && isHost); // host-only controls

      // Block player interactions for guest
      guestBlocker.style.display = (connected && !isHost) ? 'block' : 'none';

      // HTML5 controls only if host
      html5Player.controls = !!(connected && isHost);
      html5Player.tabIndex = isHost ? 0 : -1;
    }

    // Create room (become host)
    document.getElementById('createRoom').onclick = () => {
      isHost = true;
      roleBadge.textContent = 'Host';
      peer = new Peer();
      peer.on('open', id => { alert(`Room ID: ${id} (share it with your friend)`); });
      peer.on('connection', c => {
        conn = c; setupConnection(); toggleUI(true);
      });
    };

    // Join room (become guest)
    document.getElementById('joinRoom').onclick = () => {
      const id = document.getElementById('roomIdInput').value.trim();
      if (!id) return;
      isHost = false;
      roleBadge.textContent = 'Guest';
      peer = new Peer();
      peer.on('open', () => {
        conn = peer.connect(id);
        conn.on('open', () => { setupConnection(); toggleUI(true); });
      });
    };

    function setupConnection() {
      conn.on('data', data => {
        if (data.type === 'chat') {
          logBubble(data.text, 'peer');
        } else if (data.type === 'video') {
          // only host may broadcast; guests just receive and load
          if (!isHost) loadVideo(data.url, false);
        } else if (data.type === 'sync') {
          syncVideo(data);
        } else if (data.type === 'exit') {
          alert('Peer has exited the session.');
          location.reload();
        }
      });

      // enforce UI by role
      show(videoControls, isHost);
      guestBlocker.style.display = isHost ? 'none' : 'block';
      html5Player.controls = isHost;
      html5Player.tabIndex = isHost ? 0 : -1;
    }

    // Chat send
    document.getElementById('sendBtn').onclick = () => {
      const msg = document.getElementById('msgInput').value.trim();
      if (!msg) return;
      logBubble(msg, 'you');
      conn?.send({ type: 'chat', text: msg });
      document.getElementById('msgInput').value = '';
    };

    // Host-only: load video
    document.getElementById('loadVideo').onclick = () => {
      if (!isHost) return;
      const url = document.getElementById('videoUrl').value.trim();
      if (!url) return;
      loadVideo(url, true);
      conn?.send({ type: 'video', url });
    };

    // Exit button
    document.getElementById('exitBtn').onclick = () => {
      if (conn) conn.send({ type: 'exit' });
      alert('You have exited.');
      location.reload();
    };

    // Prevent any guest-side playback/seek toggles (extra safety)
    html5Player.addEventListener('play', (e) => { if (!isHost) { e.preventDefault(); html5Player.pause(); } }, true);
    html5Player.addEventListener('seeking', (e) => { if (!isHost) { e.preventDefault(); html5Player.currentTime = html5Player.currentTime; } }, true);
    html5Player.addEventListener('click', (e) => { if (!isHost) e.preventDefault(); }, true);
    // Block keyboard shortcuts from affecting player for guests
    window.addEventListener('keydown', (e) => { if (!isHost && (e.code === 'Space' || e.key === 'k')) { e.preventDefault(); } }, true);

    function cleanupPlayers() {
      // Stop/destroy YouTube
      const ytWrap = document.getElementById('ytPlayer');
      ytWrap.innerHTML = '';
      ytPlayer = null;

      // Stop/destroy hls.js
      if (hls) { try { hls.destroy(); } catch (_) {} hls = null; }

      // Reset HTML5 video
      html5Player.pause();
      html5Player.removeAttribute('src');
      html5Player.load();
    }

    function loadVideo(url, isLocalHost) {
      cleanupPlayers();
      currentType = null;

      // YouTube detection
      if (url.includes('youtube.com') || url.includes('youtu.be')) {
        currentType = 'yt';
        const id = extractYouTubeID(url);
        new YT.Player('ytPlayer', {
          height: '100%',
          width: '100%',
          videoId: id,
          playerVars: {
            controls: isHost ? 1 : 0,
            disablekb: isHost ? 0 : 1,
            modestbranding: 1,
            rel: 0
          },
          events: {
            onReady: e => {
              ytPlayer = e.target;
              // host sends initial pause+time to sync
              if (!isHost) return;
              setTimeout(() => {
                conn?.send({ type: 'sync', action: 'pause', time: ytPlayer.getCurrentTime() });
              }, 500);
            },
            onStateChange: onYTStateChange
          }
        });

        // overlay/controls by role
        guestBlocker.style.display = (!isHost) ? 'block' : 'none';
        html5Player.controls = !!isHost;
        html5Player.tabIndex = isHost ? 0 : -1;
        return;
      }

      // HLS (.m3u8) detection
      if (url.toLowerCase().includes('.m3u8')) {
        currentType = 'hls';
        if (window.Hls && Hls.isSupported()) {
          hls = new Hls({ backBufferLength: 600, liveSyncDuration: 6, liveMaxLatencyDuration: 300 });
          hls.on(Hls.Events.ERROR, (evt, data) => { console.warn('hls.js error', data); });
          hls.loadSource(url);
          hls.attachMedia(html5Player);
        } else if (html5Player.canPlayType('application/vnd.apple.mpegurl')) {
          // Safari / iOS: native HLS
          html5Player.src = url;
        } else {
          logBubble('<b>Player:</b> This browser cannot play HLS and hls.js is unavailable.', 'system');
        }
        guestBlocker.style.display = (!isHost) ? 'block' : 'none';
        html5Player.controls = !!isHost;
        html5Player.tabIndex = isHost ? 0 : -1;
        return;
      }

      // Otherwise assume direct media (mp4/webmâ€¦)
      currentType = 'html5';
      html5Player.src = url;
      guestBlocker.style.display = (!isHost) ? 'block' : 'none';
      html5Player.controls = !!isHost;
      html5Player.tabIndex = isHost ? 0 : -1;
    }

    function extractYouTubeID(url) {
      const regExp = /^.*(?:youtu\.be\/|v=|\/v\/|embed\/)([^#&?]{11})/;
      const match = url.match(regExp);
      return match ? match[1] : null;
    }

    function onYTStateChange(event) {
      if (!isHost || !conn || !ytPlayer) return;
      const state = event.data;
      const time = ytPlayer.getCurrentTime();
      if (state === YT.PlayerState.PLAYING) {
        conn.send({ type: 'sync', action: 'play', time });
      } else if (state === YT.PlayerState.PAUSED) {
        conn.send({ type: 'sync', action: 'pause', time });
      }
    }

    // Sync events for HTML5/HLS
    html5Player.onplay = () => {
      if (isHost && conn) conn.send({ type: 'sync', action: 'play', time: html5Player.currentTime });
    };
    html5Player.onpause = () => {
      if (isHost && conn) conn.send({ type: 'sync', action: 'pause', time: html5Player.currentTime });
    };
    html5Player.onseeked = () => {
      if (isHost && conn) conn.send({ type: 'sync', action: 'seek', time: html5Player.currentTime });
    };

    function syncVideo(data) {
      // YouTube
      if (currentType === 'yt' && ytPlayer) {
        ytPlayer.seekTo(data.time, true);
        if (data.action === 'play') ytPlayer.playVideo();
        else if (data.action === 'pause') ytPlayer.pauseVideo();
        return;
      }
      // HTML5/HLS
      if (currentType === 'html5' || currentType === 'hls') {
        if (Math.abs(html5Player.currentTime - data.time) > 0.5) {
          html5Player.currentTime = data.time;
        }
        if (data.action === 'play') html5Player.play().catch(()=>{});
        if (data.action === 'pause') html5Player.pause();
      }
    }

    // Collapsible chat (Bootstrap-friendly)
    document.getElementById('toggleChatBtn').onclick = () => {
      if (chatPane.style.display === 'none') {
        chatPane.style.display = '';
      } else {
        chatPane.style.display = 'none';
      }
    };

    // Draggable horizontal resizer (between video & chat)
    let isDragging = false, startY = 0, startVidHeight = 0;
    resizerX.addEventListener('mousedown', (e) => {
      isDragging = true; startY = e.clientY; startVidHeight = videoPane.getBoundingClientRect().height;
      document.body.style.userSelect = 'none';
    });
    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const wrapper = document.getElementById('appWrap');
      const total = wrapper.getBoundingClientRect().height;
      let newHeight = startVidHeight + (e.clientY - startY);
      const min = total * 0.2, max = total * 0.8; // keep 20%..80%
      newHeight = Math.max(min, Math.min(max, newHeight));
      const pct = (newHeight / total) * 100;
      videoPane.style.height = pct + '%';
      chatPane.style.height  = (100 - pct) + '%';
    });
    window.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; document.body.style.userSelect=''; } });
  </script>
</body>
</html>
