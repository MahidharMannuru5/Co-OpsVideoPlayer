<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watch Together ‚Äî Mobile Friendly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --accent:#00e1ff;
      --accent2:#ff00aa;
      --bg:#0f0f10;
      --panel:#17191e;
      --panel2:#121419;
      --text:#ebeff3;
      --muted:#9aa4ae;
      --border:#232832;
      --shadow:0 1px 2px rgba(0,0,0,.2), 0 10px 20px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4
    }

    /* layout */
    .page{min-height:100dvh;display:flex;flex-direction:column}
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(0deg,var(--panel),var(--panel2));
      border-bottom:1px solid var(--border);
      padding:10px 12px
    }
    .row{max-width:1024px;margin:0 auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    h1{margin:0;font-size:18px;color:var(--accent)}
    main{flex:1;padding:12px}
    .container{max-width:1024px;margin:0 auto;display:flex;flex-direction:column;gap:12px}

    /* cards */
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .stack{display:flex;flex-direction:column;gap:8px}

    /* controls */
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bar .grow{flex:1}
    .badge{padding:4px 10px;border-radius:999px;background:#101217;border:1px solid var(--border);color:var(--muted);font-size:12px}
    .badge.host{color:var(--accent);background:rgba(0,225,255,.1);border-color:rgba(0,225,255,.3)}
    .badge.peer{color:var(--accent2);background:rgba(255,0,170,.1);border-color:rgba(255,0,170,.3)}

    input[type=text]{width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1116;color:var(--text)}
    .btn{
      padding:12px 14px;border:1px solid var(--border);border-radius:10px;
      background:#0f1116;color:var(--text);font-weight:600;cursor:pointer;touch-action:manipulation
    }
    .btn.primary{background:var(--accent);color:#001218;border-color:transparent}
    .btn.warn{background:#ffc857;color:#222;border-color:#e2a900}
    .btn:active{transform:translateY(1px)}
    .btn-block{width:100%}

    /* video */
    .video-card{padding:0;overflow:hidden}
    .video-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden}
    .video-wrap iframe,.video-wrap video{position:absolute;inset:0;width:100%;height:100%}

    /* host controls (sticky under header on scroll) */
    .host-controls{position:sticky;top:62px;z-index:5;border-radius:12px}
    @media (min-width: 480px){ .host-controls{top:66px} }

    /* chat */
    .chat{display:flex;flex-direction:column;gap:8px}
    #messages{
      height:28dvh;min-height:180px;max-height:45dvh;overflow:auto;
      background:#0f1116;border:1px solid var(--border);border-radius:10px;padding:10px
    }
    .msg{margin:0 0 8px}
    .me{color:#a5ffd6}
    .peer{color:#ffd6f6}
    .sys{color:#9aa4ae}
    .chat-input{display:flex;gap:8px;align-items:center}
    .chat-input input{flex:1}

    /* mobile tweaks */
    @media (max-width: 480px){
      header .row{gap:6px}
      .btn{padding:12px}
      .host-controls .bar{gap:6px}
      #messages{height:32dvh}
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
<div class="page">
  <header>
    <div class="row">
      <h1>üé¨ Watch Together</h1>
      <div class="grow"></div>
      <button id="createRoom" class="btn">Create Room</button>
      <input id="roomIdInput" type="text" placeholder="Enter Room ID">
      <button id="joinRoom" class="btn primary">Join</button>
    </div>
  </header>

  <main>
    <div class="container">

      <!-- role/room + exit -->
      <div class="card bar">
        <span id="roleBadge" class="badge">Not connected</span>
        <div class="grow"></div>
        <button id="exitBtn" class="btn warn">Exit</button>
      </div>

      <!-- URL loader -->
      <div class="card stack">
        <input id="videoUrl" type="text" placeholder="Paste YouTube / .mp4 / .m3u8 URL and hit Load" />
        <button id="loadVideo" class="btn primary btn-block">Load</button>
      </div>

      <!-- Player -->
      <div class="card video-card">
        <div class="video-wrap">
          <div id="ytPlayer"></div>
          <video id="html5Player" playsinline controls style="display:none;"></video>
        </div>
      </div>

      <!-- Host controls (always visible; only host actions broadcast) -->
      <div class="card host-controls">
        <div class="bar">
          <button id="playBtn" class="btn">‚ñ∂Ô∏é Play</button>
          <button id="pauseBtn" class="btn">‚è∏ Pause</button>
          <button id="back10" class="btn">‚è™ ‚àí10s</button>
          <button id="fwd10" class="btn">‚è© +10s</button>
          <button id="syncBtn" class="btn">üîÅ Resync</button>
          <div class="grow"></div>
          <span class="badge">Host actions sync to peer</span>
        </div>
      </div>

      <!-- Chat at bottom -->
      <div class="card chat" id="chatCard">
        <div id="messages"></div>
        <div class="chat-input">
          <input id="msgInput" type="text" placeholder="Type a message and press Enter‚Ä¶" />
          <button id="sendBtn" class="btn primary">Send</button>
        </div>
      </div>

    </div>
  </main>
</div>

<script>
  // ===== state =====
  let peer, conn;
  let isHost = false;
  let ytPlayer = null;
  const html5Player = document.getElementById('html5Player');
  let currentType = null;   // 'yt' | 'html5' | 'hls'
  let hls = null;           // hls.js instance

  // ===== ui helpers =====
  const $ = (id)=>document.getElementById(id);
  const roleBadge = $('roleBadge');
  function setRoleBadge(text, role){
    roleBadge.textContent = text;
    roleBadge.className = 'badge ' + (role || '');
  }
  function log(html, cls){
    const box = $('messages');
    const line = document.createElement('div');
    line.className = 'msg ' + (cls||'');
    line.innerHTML = html;
    box.appendChild(line);
    box.scrollTop = box.scrollHeight;
  }

  // ===== connection =====
  $('createRoom').onclick = () => {
    isHost = true;
    peer = new Peer();
    peer.on('open', id => {
      setRoleBadge(`Host ‚Ä¢ Room: ${id}`, 'host');
      alert(`Room ID: ${id}\nShare this with your friend to join.`);
      log(`<span class="sys">Room created: <b>${id}</b></span>`, 'sys');
    });
    peer.on('connection', c => {
      conn = c; setupConnection();
      log('<span class="sys">Peer connected</span>', 'sys');
    });
  };

  $('joinRoom').onclick = () => {
    const id = $('roomIdInput').value.trim();
    if (!id) return alert('Enter a Room ID');
    isHost = false;
    peer = new Peer();
    peer.on('open', () => {
      conn = peer.connect(id);
      conn.on('open', () => { setupConnection(); setRoleBadge('Peer', 'peer'); log('<span class="sys">Connected to host</span>','sys'); });
    });
  };

  function setupConnection(){
    conn.on('data', data => {
      if (data.type === 'chat') {
        log(`<b class="peer">Peer:</b> ${escapeHtml(data.text)}`);
      } else if (data.type === 'video') {
        loadVideo(data.url, false);
      } else if (data.type === 'sync') {
        applySync(data);
      } else if (data.type === 'exit') {
        alert('Peer exited.'); location.reload();
      }
    });
  }

  $('exitBtn').onclick = () => {
    if (conn) conn.send({type:'exit'});
    alert('You exited.'); location.reload();
  };

  // ===== chat =====
  $('sendBtn').onclick = sendChat;
  $('msgInput').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') sendChat();
  });
  function sendChat(){
    const el = $('msgInput'); const msg = el.value.trim();
    if (!msg) return;
    log(`<b class="me">You:</b> ${escapeHtml(msg)}`);
    conn?.send({type:'chat', text: msg});
    el.value = '';
  }
  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

  // ===== load video =====
  $('loadVideo').onclick = () => {
    const url = $('videoUrl').value.trim();
    if (!url) return;
    loadVideo(url, true);
    conn?.send({type:'video', url});
  };

  function cleanupPlayers(){
    // YouTube
    $('ytPlayer').innerHTML = ''; ytPlayer = null;
    // hls
    if (hls) { try{ hls.destroy(); }catch(e){} hls = null; }
    // html5
    html5Player.pause();
    html5Player.removeAttribute('src');
    html5Player.load();
    html5Player.style.display = 'none';
  }

  function loadVideo(url, isLocalHost){
    cleanupPlayers();
    currentType = null;

    // YouTube
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
      currentType = 'yt';
      const id = extractYouTubeID(url);
      new YT.Player('ytPlayer', {
        height: '100%', width:'100%', videoId:id,
        events:{
          onReady: e => {
            ytPlayer = e.target;
            if (isHost && conn) setTimeout(()=> conn.send({type:'sync', action:'pause', time: ytPlayer.getCurrentTime()}), 400);
          },
          onStateChange: onYTStateChange
        }
      });
      return;
    }

    // HLS
    if (url.toLowerCase().includes('.m3u8')) {
      currentType = 'hls';
      html5Player.style.display = 'block';
      if (window.Hls && Hls.isSupported()) {
        hls = new Hls({
          backBufferLength: 600,
          liveSyncDuration: 6,
          liveMaxLatencyDuration: 300
        });
        hls.on(Hls.Events.ERROR, (_, data)=> console.warn('hls.js error', data));
        hls.loadSource(url);
        hls.attachMedia(html5Player);
      } else if (html5Player.canPlayType('application/vnd.apple.mpegurl')) {
        html5Player.src = url; // Safari
      } else {
        log('<span class="sys">This browser cannot play HLS and hls.js is unavailable.</span>', 'sys');
      }
      return;
    }

    // Direct file
    currentType = 'html5';
    html5Player.src = url;
    html5Player.style.display = 'block';
  }

  function extractYouTubeID(url){
    const re = /^.*(?:youtu\.be\/|v=|\/v\/|embed\/)([^#&?]{11})/;
    const m = url.match(re); return m ? m[1] : null;
  }

  // ===== host controls (play/pause/seek ¬±10/resync) =====
  $('playBtn').onclick  = ()=> hostAction('play');
  $('pauseBtn').onclick = ()=> hostAction('pause');
  $('back10').onclick   = ()=> hostSeekDelta(-10);
  $('fwd10').onclick    = ()=> hostSeekDelta(+10);
  $('syncBtn').onclick  = ()=> hostAction('sync');

  function hostAction(kind){
    if (!isHost || !conn) return;
    if (currentType === 'yt' && ytPlayer){
      if (kind==='play') ytPlayer.playVideo();
      if (kind==='pause') ytPlayer.pauseVideo();
      const t = ytPlayer.getCurrentTime();
      conn.send({type:'sync', action: (kind==='sync'?'seek':kind), time: t});
    } else if (currentType==='html5' || currentType==='hls'){
      if (kind==='play') html5Player.play().catch(()=>{});
      if (kind==='pause') html5Player.pause();
      const t = html5Player.currentTime;
      conn.send({type:'sync', action: (kind==='sync'?'seek':kind), time: t});
    }
  }

  function hostSeekDelta(delta){
    if (!isHost || !conn) return;
    let t = 0;
    if (currentType==='yt' && ytPlayer){
      t = Math.max(0, ytPlayer.getCurrentTime() + delta);
      ytPlayer.seekTo(t, true);
    } else if ((currentType==='html5' || currentType==='hls') && html5Player.duration){
      t = Math.max(0, Math.min((isFinite(html5Player.duration)?html5Player.duration:1e12), html5Player.currentTime + delta));
      html5Player.currentTime = t;
    }
    conn.send({type:'sync', action:'seek', time: t});
  }

  // ===== sync plumbing =====
  function onYTStateChange(event){
    if (!isHost || !conn) return;
    const t = ytPlayer.getCurrentTime();
    if (event.data === YT.PlayerState.PLAYING) conn.send({type:'sync', action:'play', time:t});
    if (event.data === YT.PlayerState.PAUSED)  conn.send({type:'sync', action:'pause', time:t});
  }

  html5Player.onplay   = ()=> { if (isHost && conn) conn.send({type:'sync', action:'play',  time:html5Player.currentTime}); };
  html5Player.onpause  = ()=> { if (isHost && conn) conn.send({type:'sync', action:'pause', time:html5Player.currentTime}); };
  html5Player.onseeked = ()=> { if (isHost && conn) conn.send({type:'sync', action:'seek',  time:html5Player.currentTime}); };

  function applySync(msg){
    if (currentType==='yt' && ytPlayer){
      ytPlayer.seekTo(msg.time, true);
      if (msg.action==='play') ytPlayer.playVideo();
      if (msg.action==='pause') ytPlayer.pauseVideo();
      return;
    }
    if (currentType==='html5' || currentType==='hls'){
      if (Math.abs(html5Player.currentTime - msg.time) > 0.5) html5Player.currentTime = msg.time;
      if (msg.action==='play') html5Player.play().catch(()=>{});
      if (msg.action==='pause') html5Player.pause();
    }
  }
</script>
</body>
</html>
