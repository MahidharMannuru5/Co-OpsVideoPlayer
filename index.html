<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PeerJS Minimal — Create/Join Test</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Arial,sans-serif;background:#0c0d0f;color:#e8eef3;margin:0;display:flex;min-height:100vh;align-items:center;justify-content:center}
  .card{background:#14171b;border:1px solid #232834;border-radius:14px;padding:16px;width:min(520px,92vw)}
  .row{display:flex;gap:8px;margin:10px 0}
  input{flex:1;padding:10px;border-radius:10px;border:1px solid #232834;background:#0f1116;color:#e8eef3}
  button{padding:10px 12px;border-radius:10px;border:1px solid #232834;background:#00e1ff;color:#001218;font-weight:700;cursor:pointer}
  pre{background:#0f1116;border:1px solid #232834;border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word;max-height:40vh;overflow:auto}
</style>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>PeerJS Minimal — Create/Join Test</h2>
    <div class="row">
      <button id="create">Create (Host)</button>
      <input id="room" placeholder="Room ID to join">
      <button id="join">Join (Guest)</button>
    </div>
    <div class="row">
      <input id="msg" placeholder="Type a message…">
      <button id="send">Send</button>
    </div>
    <pre id="log" aria-live="polite"></pre>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const log = (m) => { const l = $('#log'); l.textContent += m + '\n'; l.scrollTop = l.scrollHeight; };

  let peer = null;
  let conn = null;

  // Use basic STUN; add your TURN here if needed
  function peerOptions(){
    return {
      debug: 2,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
          // { urls: 'turn:YOUR_TURN_HOST:3478', username: 'USER', credential: 'PASS' }
        ]
      }
    };
  }

  function wireConn(c){
    conn = c;
    log('[conn] wiring…');
    conn.on('open', () => log('[conn] OPEN ✓'));
    conn.on('data', d => log('[conn] data: ' + JSON.stringify(d)));
    conn.on('close', () => log('[conn] CLOSED'));
    conn.on('error', e => log('[conn] ERROR ' + (e?.message || e)));
  }

  $('#create').onclick = () => {
    if (peer) { try { peer.destroy(); } catch(e){} }
    log('[host] creating Peer…');
    peer = new Peer(peerOptions());

    const watchdog = setTimeout(() => log('[host] WARN: signaling watchdog fired'), 8000);

    peer.on('open', id => { clearTimeout(watchdog); log('[host] open id = ' + id); });
    peer.on('connection', c => { log('[host] incoming connection'); wireConn(c); });
    peer.on('error', e => log('[host] ERROR ' + (e?.message || e)));
    peer.on('disconnected', () => log('[host] DISCONNECTED'));
  };

  $('#join').onclick = () => {
    const id = $('#room').value.trim();
    if (!id) { log('[join] enter a Room ID'); $('#room').focus(); return; }

    if (peer) { try { peer.destroy(); } catch(e){} }
    log('[join] creating Peer…');
    peer = new Peer(peerOptions());

    const watchdog = setTimeout(() => log('[join] WARN: signaling watchdog fired'), 8000);

    peer.on('open', () => {
      clearTimeout(watchdog);
      log('[join] peer open, connecting to ' + id);
      const c = peer.connect(id);
      wireConn(c);

      // Join timeout if never opens
      setTimeout(() => {
        if (!c.open) log('[join] ERROR: data connection timed out (wrong ID / host gone / network blocks WebRTC)');
      }, 10000);
    });
    peer.on('error', e => log('[join] ERROR ' + (e?.message || e)));
  };

  $('#send').onclick = () => {
    const txt = $('#msg').value.trim();
    if (!txt) return;
    if (!conn || !conn.open) { log('[send] no open connection'); return; }
    conn.send({msg: txt, ts: Date.now()});
    log('[send] ' + txt);
    $('#msg').value = '';
  };
})();
</script>
</body>
</html>
