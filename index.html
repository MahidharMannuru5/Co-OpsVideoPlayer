<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watch Together â€” Video + Chat Only</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg:#0f1013; --panel:#15171c; --border:#232834;
      --text:#e9eef3; --muted:#98a3ad; --accent:#00e1ff; --peer:#ff72d2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* screens */
    .screen{height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
    .hidden{display:none !important}

    /* connect screen */
    .connect{
      width:100%;max-width:420px;background:var(--panel);border:1px solid var(--border);
      border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:10px
    }
    .title{font-weight:700;color:var(--accent);text-align:center}
    input,button{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);
      background:#0f1116;color:var(--text);font-weight:600
    }
    button{background:var(--accent);color:#001218;border-color:transparent;cursor:pointer}
    .sub{color:var(--muted);font-size:13px;text-align:center}
    .row{display:flex;gap:8px}

    /* session screen: fixed video+chat, no page scroll */
    .session{
      height:100vh;display:flex;flex-direction:column;gap:8px;padding:8px
    }
    .videoWrap{
      flex:2;min-height:45vh;background:#000;border-radius:12px;overflow:hidden;
      border:1px solid var(--border);position:relative
    }
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000}
    .role-host video{pointer-events:auto}
    .role-peer video{pointer-events:none} /* guest can't interact */

    .chat{
      flex:1;min-height:32vh;background:var(--panel);border:1px solid var(--border);
      border-radius:12px;display:flex;flex-direction:column;overflow:hidden
    }
    #messages{
      flex:1;overflow:auto;padding:10px;background:#0f1116
    }
    .msg{margin:0 0 8px}
    .me{color:#b4ffd9}
    .peer{color:#ffd6f6}
    .sys{color:var(--muted)}
    .composer{display:flex;gap:8px;padding:8px;border-top:1px solid var(--border);background:var(--panel)}
    .composer input{flex:1}
    .composer button{width:auto}

    /* tiny badges on top-left */
    .badges{
      position:absolute;top:8px;left:8px;display:flex;gap:6px;z-index:2
    }
    .badge{
      background:rgba(0,0,0,.5);backdrop-filter:saturate(120%) blur(6px);
      color:#eaf2f7;border:1px solid rgba(255,255,255,.12);padding:4px 8px;border-radius:999px;
      font-size:12px
    }

    @media (max-width:480px){
      .session{gap:6px;padding:6px}
      .chat{min-height:38vh}
      .composer input, .composer button{padding:12px}
    }
  </style>

  <!-- PeerJS & hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

<!-- CONNECT SCREEN -->
<section id="connectScreen" class="screen">
  <div class="connect">
    <div class="title">ðŸŽ¬ Watch Together</div>
    <div class="sub">Only video + chat will be visible after connection.</div>
    <button id="createBtn">Create Room (Host)</button>
    <div class="row">
      <input id="roomId" placeholder="Enter Room ID (to join)" />
      <button id="joinBtn">Join</button>
    </div>
    <div id="connectLog" class="sub"></div>
  </div>
</section>

<!-- SESSION SCREEN -->
<section id="sessionScreen" class="screen hidden">
  <div id="sessionRoot" class="session">
    <div class="videoWrap">
      <div class="badges">
        <span id="roleBadge" class="badge">Not connected</span>
        <span id="statusBadge" class="badge">Idle</span>
      </div>
      <video id="player" playsinline></video>
    </div>
    <div class="chat">
      <div id="messages"></div>
      <div class="composer">
        <input id="msgInput" placeholder="Messageâ€¦  (host: /load <url>)" />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>
</section>

<script>
  // ===== Shortcuts =====
  const $ = id => document.getElementById(id);
  const connectScreen = $('connectScreen');
  const sessionScreen = $('sessionScreen');
  const sessionRoot   = $('sessionRoot');
  const roleBadge     = $('roleBadge');
  const statusBadge   = $('statusBadge');
  const player        = $('player');
  const messages      = $('messages');

  let peer, conn, isHost = false;
  let hls = null;
  let videoLoaded = false;

  // ===== UI helpers =====
  function showConnect(msg){ $('connectLog').textContent = msg || ''; }
  function toSession(role){
    connectScreen.classList.add('hidden');
    sessionScreen.classList.remove('hidden');
    sessionRoot.classList.toggle('role-host', role==='host');
    sessionRoot.classList.toggle('role-peer', role!=='host');
    roleBadge.textContent = role==='host' ? 'Host' : 'Guest';
    // built-in controls only for host
    if (role==='host') { player.setAttribute('controls',''); }
    else { player.removeAttribute('controls'); }
  }
  function log(html, cls){
    const div = document.createElement('div');
    div.className = 'msg ' + (cls||'');
    div.innerHTML = html;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }
  function setStatus(text){ statusBadge.textContent = text; }

  // ===== Connection flow =====
  $('createBtn').onclick = () => {
    isHost = true;
    peer = new Peer();
    peer.on('open', id => {
      showConnect(`Room ID: ${id}`);
      log(`<span class="sys">Room created: <b>${id}</b></span>`, 'sys');
    });
    peer.on('connection', c => {
      conn = c;
      wireConnection();
      toSession('host');
      promptForSource(); // ask once after connect
    });
  };

  $('joinBtn').onclick = () => {
    const id = $('roomId').value.trim();
    if (!id) return showConnect('Enter a room ID.');
    isHost = false;
    peer = new Peer();
    peer.on('open', () => {
      conn = peer.connect(id);
      conn.on('open', () => {
        wireConnection();
        toSession('guest');
      });
    });
  };

  function wireConnection(){
    conn.on('data', data => {
      if (data.type === 'chat'){
        log(`<b class="peer">Peer:</b> ${escapeHtml(data.text)}`, 'peer');
      } else if (data.type === 'cmd' && data.cmd === 'load'){
        loadMedia(data.url, /*broadcast*/ false);
      } else if (data.type === 'sync'){
        applySync(data);
      }
    });
    conn.on('close', () => location.reload());
  }

  // ===== Chat (Enter to send, /load for host) =====
  $('sendBtn').onclick = sendMsg;
  $('msgInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMsg();
  });
  function sendMsg(){
    const el = $('msgInput'); const text = el.value.trim();
    if (!text) return;
    if (isHost && text.startsWith('/load ')){
      const url = text.slice(6).trim();
      if (url) loadMedia(url, /*broadcast*/ true);
      el.value = ''; return;
    }
    log(`<b class="me">You:</b> ${escapeHtml(text)}`, 'me');
    conn?.send({type:'chat', text});
    el.value = '';
  }

  // ===== Host: initial prompt for URL =====
  function promptForSource(){
    const url = prompt('Host: paste media URL (.mp4/.webm or .m3u8)');
    if (url) loadMedia(url, /*broadcast*/ true);
  }

  // ===== Load media (HTML5 + HLS) =====
  function cleanup(){
    if (hls){ try{ hls.destroy(); }catch(e){} hls = null; }
    player.pause();
    player.removeAttribute('src');
    player.load();
    videoLoaded = false;
  }

  function loadMedia(url, broadcast){
    cleanup();
    setStatus('Loadingâ€¦');

    if (url.toLowerCase().includes('.m3u8')){
      if (window.Hls && Hls.isSupported()){
        hls = new Hls({ backBufferLength: 600, liveSyncDuration: 6, liveMaxLatencyDuration: 300 });
        hls.on(Hls.Events.ERROR, (_, data)=> console.warn('hls.js error', data));
        hls.loadSource(url);
        hls.attachMedia(player);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
          videoLoaded = true; setStatus('Ready');
          if (!isHost) player.currentTime = 0;
        });
      } else if (player.canPlayType('application/vnd.apple.mpegurl')){
        player.src = url; // Safari/iOS native
        player.onloadedmetadata = ()=>{ videoLoaded = true; setStatus('Ready'); };
      } else {
        setStatus('HLS unsupported in this browser'); return;
      }
    } else {
      player.src = url;
      player.onloadedmetadata = ()=>{ videoLoaded = true; setStatus('Ready'); };
    }

    if (broadcast) {
      conn?.send({ type:'cmd', cmd:'load', url });
      log(`<span class="sys">Loaded: ${escapeHtml(url)}</span>`, 'sys');
    } else {
      log(`<span class="sys">Source set by host</span>`, 'sys');
    }
  }

  // ===== Sync: host -> guest via native events =====
  player.addEventListener('play', () => {
    if (!isHost || !videoLoaded) return;
    conn?.send({type:'sync', action:'play', time:player.currentTime});
  });
  player.addEventListener('pause', () => {
    if (!isHost || !videoLoaded) return;
    conn?.send({type:'sync', action:'pause', time:player.currentTime});
  });
  let seekTimer;
  player.addEventListener('seeked', () => {
    if (!isHost || !videoLoaded) return;
    clearTimeout(seekTimer);
    seekTimer = setTimeout(()=> {
      conn?.send({type:'sync', action:'seek', time:player.currentTime});
    }, 80);
  });

  function applySync(msg){
    if (!videoLoaded) return;
    const diff = Math.abs(player.currentTime - msg.time);
    if (diff > 0.4) player.currentTime = msg.time;
    if (msg.action === 'play')  player.play().catch(()=>{});
    if (msg.action === 'pause') player.pause();
  }

  // ===== utils =====
  function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

</script>
</body>
</html>
